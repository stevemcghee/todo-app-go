name: Build and Test

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22.x'

    - name: Build Go application
      run: |
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o main .

    - name: Run Go tests
      run: go test -v ./...

    - name: Run Chaos Tests
      run: go test -tags chaos -v ./test/chaos/...

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ vars.GCP_PROJECT_ID }}

    - name: Configure Docker to push to Artifact Registry
      run: gcloud auth configure-docker ${{ vars.GCR_HOSTNAME }}

    - name: Build and Push Docker image
      env:
        IMAGE_NAME: todo-app-go
        IMAGE_TAG: ${{ github.sha }}
        GCR_HOSTNAME: ${{ vars.GCR_HOSTNAME }}
        GAR_REPOSITORY: todo-app-go
        GCP_PROJECT: ${{ vars.GCP_PROJECT_ID }}
      run: |
        docker build -t $GCR_HOSTNAME/$GCP_PROJECT/$GAR_REPOSITORY/$IMAGE_NAME:$IMAGE_TAG .
        docker push $GCR_HOSTNAME/$GCP_PROJECT/$GAR_REPOSITORY/$IMAGE_NAME:$IMAGE_TAG

    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.5.0

    - name: Sign image with a keyless signature
      env:
        IMAGE_NAME: todo-app-go
        IMAGE_TAG: ${{ github.sha }}
        GCR_HOSTNAME: ${{ vars.GCR_HOSTNAME }}
        GAR_REPOSITORY: todo-app-go
        GCP_PROJECT: ${{ vars.GCP_PROJECT_ID }}
      run: |
        IMAGE_PATH="$GCR_HOSTNAME/$GCP_PROJECT/$GAR_REPOSITORY/$IMAGE_NAME:$IMAGE_TAG"
        echo "Signing image: $IMAGE_PATH"
        cosign sign --yes "$IMAGE_PATH"

  security_scan:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: ./...

      - name: Run Trivy vulnerability scanner (fs mode)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  deploy:
    runs-on: ubuntu-latest
    needs: [build, security_scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Get short SHA
        id: short_sha
        run: echo "sha=$(echo ${{ github.sha }} | cut -c1-8 | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Create Cloud Deploy Release
        uses: 'google-github-actions/create-cloud-deploy-release@v1'
        with:
          delivery_pipeline: 'todo-app-pipeline'
          name: 'release-${{ steps.short_sha.outputs.sha }}-${{ github.run_id }}'
          region: 'us-central1'
          images: 'todo-app-go=us-central1-docker.pkg.dev/smcghee-todo-p15n-38a6/todo-app-go/todo-app-go:${{ github.sha }}'
