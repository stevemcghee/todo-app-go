name: Build and Test

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22.x' # Use the version of Go specified in go.mod or Dockerfile

    - name: Build Go application
      run: |
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o main .

    - name: Run Go tests
      run: go test -v ./...

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ vars.GCP_PROJECT_ID }} # Use vars for project ID

    - name: Configure Docker to push to Artifact Registry
      run: gcloud auth configure-docker ${{ vars.GCR_HOSTNAME }}

    - name: Build and Push Docker image
      env:
        IMAGE_NAME: todo-app-go
        IMAGE_TAG: ${{ github.sha }}
        GCR_HOSTNAME: ${{ vars.GCR_HOSTNAME }}
        GAR_REPOSITORY: todo-app-go
      run: |
        docker build -t $GCR_HOSTNAME/$GCP_PROJECT/$GAR_REPOSITORY/$IMAGE_NAME:$IMAGE_TAG .
        docker push $GCR_HOSTNAME/$GCP_PROJECT/$GAR_REPOSITORY/$IMAGE_NAME:$IMAGE_TAG

    - name: Install kubectl
      uses: azure/setup-kubectl@v3 # Using Azure's action as it's common and reliable

    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ vars.GKE_CLUSTER_NAME }}
        location: ${{ vars.GKE_CLUSTER_LOCATION }} # This will be the zone (e.g., us-central1-a)
        project_id: ${{ vars.GCP_PROJECT_ID }}

    - name: Apply Kubernetes manifests
      env:
        IMAGE_NAME: todo-app-go
        IMAGE_TAG: ${{ github.sha }}
        GCR_HOSTNAME: ${{ vars.GCR_HOSTNAME }}
        FULL_IMAGE: ${{ vars.GCR_HOSTNAME }}/${{ env.GCP_PROJECT }}/todo-app-go/todo-app-go:${{ github.sha }}
      run: |
        # Replace placeholders in the deployment manifest
        echo "Replacing image with: $GCR_HOSTNAME/$GCP_PROJECT/todo-app-go/$IMAGE_NAME:$IMAGE_TAG"
        sed -i 's|"gcr.io/${PROJECT_ID}/todo-app-go:latest"|"'"$GCR_HOSTNAME/$GCP_PROJECT/todo-app-go/$IMAGE_NAME:$IMAGE_TAG"'"|g' k8s/deployment.yaml
        sed -i "s|\${INSTANCE_CONNECTION_NAME}|${{ vars.GKE_SQL_INSTANCE_CONNECTION_NAME }}|g" k8s/deployment.yaml
        sed -i "s|\$(DB_USER)|${{ vars.DB_USER }}|g" k8s/deployment.yaml
        sed -i "s|\$(DB_PASSWORD)|${{ secrets.DB_PASSWORD }}|g" k8s/deployment.yaml
        sed -i "s|\$(DB_NAME)|${{ vars.DB_NAME }}|g" k8s/deployment.yaml
        
        # Replace placeholders in db-init-job.yaml
        sed -i "s|\${INSTANCE_CONNECTION_NAME}|${{ vars.GKE_SQL_INSTANCE_CONNECTION_NAME }}|g" k8s/db-init-job.yaml
        sed -i "s|\$(DB_USER)|${{ vars.DB_USER }}|g" k8s/db-init-job.yaml
        sed -i "s|\$(DB_PASSWORD)|${{ secrets.DB_PASSWORD }}|g" k8s/db-init-job.yaml
        sed -i "s|\$(DB_NAME)|${{ vars.DB_NAME }}|g" k8s/db-init-job.yaml
        
        echo "Deployment after sed:"
        grep "image:" k8s/deployment.yaml
        
        # Delete existing job if any to avoid immutable field errors
        kubectl delete job db-init --ignore-not-found
        
        kubectl apply -f k8s/
  
  security_scan:
    runs-on: ubuntu-latest
    needs: build # Run after build to ensure code compiles, though can run in parallel if desired.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: ./...

      - name: Run Trivy vulnerability scanner (fs mode)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
